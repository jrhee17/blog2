<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Using rxjs as an Ephemeral Storage for Mobile Applications | Your awesome title</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Using rxjs as an Ephemeral Storage for Mobile Applications" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Problem Statement" />
<meta property="og:description" content="Problem Statement" />
<link rel="canonical" href="/blog2/devnotes/2019/01/30/using-rxjs-as-an-ephemeral-storage.html" />
<meta property="og:url" content="/blog2/devnotes/2019/01/30/using-rxjs-as-an-ephemeral-storage.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-30T11:41:24+00:00" />
<script type="application/ld+json">
{"description":"Problem Statement","@type":"BlogPosting","url":"/blog2/devnotes/2019/01/30/using-rxjs-as-an-ephemeral-storage.html","headline":"Using rxjs as an Ephemeral Storage for Mobile Applications","dateModified":"2019-01-30T11:41:24+00:00","datePublished":"2019-01-30T11:41:24+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog2/devnotes/2019/01/30/using-rxjs-as-an-ephemeral-storage.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog2/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/blog2/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog2/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog2/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Using rxjs as an Ephemeral Storage for Mobile Applications</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-01-30T11:41:24+00:00" itemprop="datePublished">Jan 30, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="problem-statement">Problem Statement</h2>

<h1 id="purpose">Purpose</h1>
<p>We are developing a Bitcoin Alarm app which simply allows users to</p>
<ul>
  <li>Add bitcoin alarms for a certain price</li>
  <li>Receive push notifications when a price is met</li>
</ul>

<p>This is a contrived version of the overall flow of the app</p>

<p><img src="/blog2/assets/20190130/asisflow_uml.png" alt="uml" /></p>

<p>A few notable points include</p>
<ul>
  <li>Many REST api calls
    <ul>
      <li>This is a rapid prototyping app meaning requirements may change suddenly</li>
    </ul>
  </li>
  <li>Websockets
    <ul>
      <li>This is for realtime ticker (coin price) updates and alarm triggers. Websockets are opened automatically on background -&gt; foreground transition.</li>
    </ul>
  </li>
</ul>

<p>The following is a sample alarm list screen</p>

<p><img src="/blog2/assets/20190130/alarm_list.png" alt="screenshot" /></p>

<p>A sample add alarm screen</p>

<p><img src="/blog2/assets/20190130/add_alarm.png" alt="screenshot" /></p>

<p>Just in case anyone isn’t familiar with crypto-jargon</p>
<ul>
  <li><code class="highlighter-rouge">exchange</code>: Entities (businesses) which trade cryptocurrency</li>
  <li><code class="highlighter-rouge">coin</code>: Type of cryptocurrency (BTC, ETH , etc.)</li>
</ul>

<h1 id="problem">Problem</h1>
<p>We would like to display <code class="highlighter-rouge">In-app-purchase to add more alarms</code>
(It’s unfortunate, but with server costs going out every month, every developer has to make <em>some</em> money)</p>

<p>The condition for which we would like to display this is</p>
<ol>
  <li>3 alarms are already added
    <ul>
      <li>Saved in server – can retrieve by REST [GET] <code class="highlighter-rouge">/alarms</code></li>
    </ul>
  </li>
  <li>The user has not purchased the app
    <ul>
      <li>Saved in server. To decide if also need to save in client</li>
    </ul>
  </li>
</ol>

<ul>
  <li>Note: Obviously we would also have to check whether the user has purchased this feature when the alarm is actually added.
This check is just to notify users before the actual purchase.</li>
</ul>

<h1 id="points-to-consider">Points to consider</h1>

<ol>
  <li>I would like to be able to maintain control over how alarms are added from the server side
    <ul>
      <li>What if I want to change the number of free alarms from <code class="highlighter-rouge">3</code> to <code class="highlighter-rouge">5</code> without app deployment?</li>
    </ul>
  </li>
  <li>I would like to minimize storage from the client side
    <ul>
      <li>What if I want to get rid of this add-alarm-restriction? Will there be useless client data/code?</li>
      <li>Data inconsistency always happens between server and clients</li>
    </ul>
  </li>
  <li>I would like to still maintain some efficiency
    <ul>
      <li>Should try to avoid calling the same api multiple times in different screens</li>
    </ul>
  </li>
  <li>I’m all for asynchronous everything, but flickering screens are not good for UX</li>
  <li>I would like a generalized pattern (redux???) that can handle calls like this
    <ul>
      <li>Unfortunately, while using <code class="highlighter-rouge">react-navigation</code> with <code class="highlighter-rouge">react-native</code>, <code class="highlighter-rouge">react-redux</code> isn’t an option.</li>
    </ul>
  </li>
  <li>Minimize number of server apis if possible</li>
</ol>

<h1 id="possible-solutions">Possible solutions</h1>
<p>With the above points in mind, I drafted the following 4 possible solutions</p>

<p><strong>Pass Parameters</strong></p>

<p><img src="/blog2/assets/20190130/passparams_uml.png" alt="uml" /></p>

<p><em>Description</em></p>
<ul>
  <li>Simply call <code class="highlighter-rouge">navigate(routeName, params)</code> with alarm list as params</li>
</ul>

<p><em>Cons</em></p>
<ul>
  <li>Always have to retrieve alarm list before navigating to add alarm screen</li>
  <li>Domain-wise Add-Alarm screen has little to do with already added alarms</li>
  <li>Hard to control add-alarm policy</li>
</ul>

<p><em>Pros</em></p>
<ul>
  <li>Simple and straightforward to achieve</li>
  <li>Efficient - no extra server calls</li>
</ul>

<p><strong>Rest Call Every Time</strong></p>

<p><em>Description</em></p>
<ul>
  <li>Call <code class="highlighter-rouge">[REST] GET alarm/addable</code> every time add alarm screen is loaded</li>
</ul>

<p><em>Cons</em></p>
<ul>
  <li>REST call every time page is loaded</li>
  <li>Need to create a non-restful api</li>
</ul>

<p><em>Pros</em></p>
<ul>
  <li>Simple and straightforward to achieve</li>
  <li>Easy to control add-alarm policy</li>
</ul>

<p><img src="/blog2/assets/20190130/rest_uml.png" alt="uml" /></p>

<p><strong>Websocket Call</strong></p>

<p><img src="/blog2/assets/20190130/socket_uml.png" alt="uml" /></p>

<p><em>Description</em></p>
<ul>
  <li>Send <code class="highlighter-rouge">{'type': 'check.alarm.addable'}</code> every time add alarm screen is loaded</li>
</ul>

<p><em>Cons</em></p>
<ul>
  <li>Minimal efficiency advantage over Rest call (assuming HTTP/2)</li>
  <li>Hard to develop good UI for asynchronous result</li>
</ul>

<p><em>Pros</em></p>
<ul>
  <li>no real advantage</li>
</ul>

<p><strong>RXJS cached variant</strong></p>

<p><img src="/blog2/assets/20190130/cached_uml.png" alt="uml" /></p>

<p><em>Description</em></p>
<ul>
  <li>Cache api calls using redux pattern and use cached to determine whether alarm is addable</li>
</ul>

<p><em>Cons</em></p>
<ul>
  <li>Challenging to implement</li>
  <li>Can’t control logic from server</li>
</ul>

<p><em>Pros</em></p>
<ul>
  <li>Efficient - no extra server calls</li>
  <li>Generic - no extra api calls</li>
  <li>Client won’t be saving anything.
Whenever app dies, all data will be reset.</li>
</ul>

<h1 id="final-verdict">Final Verdict</h1>

<p>I have decided to go with <strong>Redux pattern using RXJS</strong> because I believe it will be worth the hassle.
In my head, it will go something like this…</p>

<p><em>EphemeralStorage</em></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">EphemeralStorage</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">alarmListSubject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">BehaviorSubject</span><span class="p">([]);</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="nx">updateAlarmList</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">alarmList</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">RestClient</span><span class="p">.</span><span class="nx">getJson</span><span class="p">(</span><span class="s2">`/alarms`</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">alarmListSubject</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">alarmList</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">getAlarmListSubject</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">alarmListSubject</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">EphemeralStorage</span><span class="p">();</span>
</code></pre></div></div>

<p><em>AlarmList Screen</em></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">AlarmList</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
    
    <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">EphemeralStorage</span><span class="p">.</span><span class="nx">getAlarmListSubject</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">alarmList</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">alarmList</span><span class="p">}));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fetchAlarmList</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="nx">fetchAlarmList</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">EphemeralStorage</span><span class="p">.</span><span class="nx">updateAlarmList</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>AddAlarm Screen</em></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">AddAlarm</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
    <span class="nx">checkAlarmAddable</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">EphemeralStorage</span><span class="p">.</span><span class="nx">getAlarmListSubject</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">alarmList</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
                <span class="na">addable</span><span class="p">:</span> <span class="nx">alarmList</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">purchased</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>NOTE: Please don’t trust the code I have just written above – it is pseudocode that kind of spiralled out of control.</p>

<p>Also, some more considerations</p>

<ol>
  <li>Need to make actions more readable (possibly make it more redux-esque)</li>
  <li>Not entirely comfortable using rxjs, so I’ll need to go through the documentation again (for the 20th time…)</li>
</ol>

<p>When I’m done with this task, hopefully I’ll be able to give some updates whether I still think this was the right decision.</p>

<p><img src="/blog2/assets/20190130/new_standard.jpeg" alt="" /></p>


  </div><a class="u-url" href="/blog2/devnotes/2019/01/30/using-rxjs-as-an-ephemeral-storage.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog2/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/blog2/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/blog2/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
